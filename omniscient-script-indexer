#!/bin/bash

# Omniscient Script Indexer and Commenter
# Description: Indexes scripts, samples their content, inserts brief headers if missing, and generates a markdown file for AI ingestion.
# Author: omniscientctl
# Location: /opt/omniscient/bin/omniscient_script_indexer.sh

BASE_DIR="/opt/omniscient"
BACKUP_DIR="$HOME/.omniscient_backup_$(date +%Y%m%d_%H%M%S)"
MARKDOWN_OUT="$HOME/omniscient_script_digest.md"
LOGFILE="$HOME/omniscient_script_indexer.log"

mkdir -p "$BACKUP_DIR"

echo "# Omniscient Script Digest" > "$MARKDOWN_OUT"
echo "Generated: $(date)" >> "$MARKDOWN_OUT"
echo "" >> "$MARKDOWN_OUT"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOGFILE"
}

# Function to check if file has a shebang or comment at the top
has_comment_or_shebang() {
    head -n 1 "$1" | grep -qE '^#!|^#'
}

# Index and parse scripts
log "Starting script indexing from $BASE_DIR..."

find "$BASE_DIR" -type f -name "*.sh" -o -name "*.py" -o -name "*.pl" -o -name "*.bash" | while read -r script; do
    log "Processing $script"

    RELATIVE_PATH="${script#$BASE_DIR/}"
    FILETYPE=$(file -b --mime-type "$script")

    # Backup original
    mkdir -p "$(dirname "$BACKUP_DIR/$RELATIVE_PATH")"
    cp "$script" "$BACKUP_DIR/$RELATIVE_PATH"

    # Generate summary sample
    SAMPLE=$(head -n 15 "$script" | sed 's/^/    /')

    # Comment header if missing
    if ! has_comment_or_shebang "$script"; then
        COMMENT="# [Auto-added by indexer] Script: $(basename "$script") - Autogenerated description placeholder"
        (echo "$COMMENT"; cat "$script") > "${script}.tmp" && mv "${script}.tmp" "$script"
        log "Added header comment to $script"
    fi

    # Append to markdown digest
    echo "## Script: \`$RELATIVE_PATH\`" >> "$MARKDOWN_OUT"
    echo "- **Filetype:** $FILETYPE" >> "$MARKDOWN_OUT"
    echo "- **Relative Path:** $RELATIVE_PATH" >> "$MARKDOWN_OUT"
    echo "- **Sample Code:**" >> "$MARKDOWN_OUT"
    echo '```' >> "$MARKDOWN_OUT"
    echo "$SAMPLE" >> "$MARKDOWN_OUT"
    echo '```' >> "$MARKDOWN_OUT"
    echo "" >> "$MARKDOWN_OUT"

done

log "Indexing complete. Digest saved to: $MARKDOWN_OUT"
log "Backup of originals: $BACKUP_DIR"

# Restore option
cat <<'EOF' > "$HOME/restore_omniscient_scripts.sh"
#!/bin/bash
echo "Restoring scripts from backup..."
BACKUP_DIR="$1"
if [ ! -d "$BACKUP_DIR" ]; then
    echo "Backup directory not found: $BACKUP_DIR"
    exit 1
fi
cp -r "$BACKUP_DIR"/* /opt/omniscient/
echo "Restore complete."
EOF
chmod +x "$HOME/restore_omniscient_scripts.sh"

log "Restore script created: $HOME/restore_omniscient_scripts.sh"